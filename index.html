<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live IoT Dashboard Data</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f8ff; }
  h2 { text-align: center; color: #003d99; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
  }
  th, td {
    border: 1px solid #444;
    padding: 10px;
    text-align: center;
  }
  th {
    background: #0073e6;
    color: #fff;
  }
  tr:nth-child(even) { background: #eef5ff; }
</style>
</head>
<body>

<h2>Live IoT Dashboard Data</h2>
<table id="dataTable"></table>

<script>
const sheetID = "1xfkdl2oWvB-HSpLBRwjj31YBCb-YDTUhjTJhVnW2o_g"; 
const sheetName = "Sheet1";  // change if your tab name is different
const apiURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

function formatDateFromString(str) {
  // Handles "Date(2025,9,11)" → "11/09/2025"
  const nums = str.match(/\d+/g);
  if (!nums || nums.length < 3) return str;
  const [y, m, d] = nums.map(Number);
  const date = new Date(y, m, d); // GViz & JS both use 0-based month
  return date.toLocaleDateString("en-GB"); // dd/mm/yyyy
}

function formatTimeFromString(str) {
  // Handles "Date(1899,11,30,19,54,10)" → "7:54:10 PM"
  const nums = str.match(/\d+/g);
  if (!nums || nums.length < 6) return str;
  const [, , , hh, mm, ss] = nums.map(Number);
  const date = new Date(1970, 0, 1, hh, mm, ss);
  return date.toLocaleTimeString();
}

function loadData() {
  fetch(apiURL)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const table = document.getElementById("dataTable");

      let tableHTML = "<tr>";
      json.table.cols.forEach(col => {
        tableHTML += `<th>${col.label}</th>`;
      });
      tableHTML += "</tr>";

      json.table.rows.forEach(row => {
        tableHTML += "<tr>";
        row.c.forEach((cell, index) => {
          let value = cell ? cell.v : "";

          // If Date/Time come as Date(...) strings, format them
          if (index === 0 && typeof value === "string" && value.startsWith("Date(")) {
            value = formatDateFromString(value);
          }
          if (index === 1 && typeof value === "string" && value.startsWith("Date(")) {
            value = formatTimeFromString(value);
          }

          // Fallback if Google also provides formatted value in cell.f
          if (index === 0 && cell && cell.f && !value.toString().includes("/")) {
            value = new Date(cell.f).toLocaleDateString("en-GB");
          }

          tableHTML += `<td>${value}</td>`;
        });
        tableHTML += "</tr>";
      });

      table.innerHTML = tableHTML;
    })
    .catch(err => console.error("Error loading Google Sheet data:", err));
}

// Load immediately
loadData();

// Refresh every 1 minute (60000 ms)
setInterval(loadData, 60000);
</script>

</body>
</html>
