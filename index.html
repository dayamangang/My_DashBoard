<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IoT-based Aquaponic Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f8ff;
    }
    h1 {
      text-align: center;
      color: #003d99;
      margin-bottom: 10px;
    }
    h2 {
      color: #003d99;
      margin-top: 30px;
      margin-bottom: 10px;
    }
    .updated-time {
      text-align: center;
      font-size: 12px;
      color: #555;
      margin-bottom: 5px;
    }
    .credit {
      text-align: center;
      font-size: 12px;
      color: #333;
      margin-bottom: 20px;
    }
    .chart-container {
      max-width: 1100px;
      margin: 0 auto 40px auto;
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    canvas {
      width: 100% !important;
      height: 350px !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>IoT-based Aquaponic Dashboard</h1>
<div class="updated-time" id="updatedTime">Loading data…</div>
<p class="credit"><strong>Developed by Dr. Huidrom Dayananda Singh</strong></p>

<div class="chart-container">
  <h2>Latest Reading – All Parameters</h2>
  <canvas id="latestChart"></canvas>
</div>

<div class="chart-container">
  <h2>Air Temperature – Last 12 Hours</h2>
  <canvas id="airTempChart"></canvas>
</div>

<div class="chart-container">
  <h2>Air Humidity – Last 12 Hours</h2>
  <canvas id="humidityChart"></canvas>
</div>

<div class="chart-container">
  <h2>Water Temperature – Last 12 Hours</h2>
  <canvas id="waterTempChart"></canvas>
</div>

<div class="chart-container">
  <h2>NPK – Last 12 Hours</h2>
  <canvas id="npkChart"></canvas>
</div>

<script>
const sheetID = "1xfkdl2oWvB-HSpLBRwjj31YBCb-YDTUhjTJhVnW2o_g";
const sheetName = "Sheet1";
const apiURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

let latestChart, airTempChart, humidityChart, waterTempChart, npkChart;

// Zero smoothing ONLY for AirTemp, Humidity, WaterTemp
function fixZeros(arr) {
  for (let i = 0; i < arr.length; i++) {
    if (arr[i] === 0 || isNaN(arr[i])) {
      let prev = arr.slice(0, i).reverse().find(v => v !== 0 && !isNaN(v));
      let next = arr.slice(i + 1).find(v => v !== 0 && !isNaN(v));
      if (prev !== undefined && next !== undefined) arr[i] = (prev + next) / 2;
      else if (prev !== undefined) arr[i] = prev;
      else if (next !== undefined) arr[i] = next;
    }
  }
  return arr;
}

function parseDateTime(d, t) {
  const dn = d?.match(/\d+/g);
  if (!dn) return null;
  let dt = new Date(+dn[0], +dn[1], +dn[2]);
  const tn = t?.match(/\d+/g);
  if (tn) dt.setHours(+tn[3], +tn[4], +tn[5]);
  return dt;
}

function loadData() {
  fetch(apiURL)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const rows = json.table.rows;
      const now = new Date();
      const cutoff = new Date(now.getTime() - 12 * 60 * 60 * 1000);

      const labels = [], air = [], hum = [], wat = [], n=[], p=[], k=[];
      let lastRecord = null;

      rows.forEach(row => {
        const c = row.c;
        const ts = parseDateTime(c[0]?.v, c[1]?.v);
        if (!ts) return;

        lastRecord = {
          ts,
          airTemp: +c[2]?.v,
          humidity: +c[3]?.v,
          waterTemp: +c[4]?.v,
          n: +c[5]?.v,
          p: +c[6]?.v,
          k: +c[7]?.v,
          tN: +c[8]?.v,
          tP: +c[9]?.v,
          tK: +c[10]?.v
        };

        if (ts >= cutoff) {
          labels.push(ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
          air.push(lastRecord.airTemp);
          hum.push(lastRecord.humidity);
          wat.push(lastRecord.waterTemp);
          n.push(lastRecord.n);
          p.push(lastRecord.p);
          k.push(lastRecord.k);
        }
      });

      if (!lastRecord) return;

      const airFix = fixZeros([...air]);
      const humFix = fixZeros([...hum]);
      const watFix = fixZeros([...wat]);

      document.getElementById("updatedTime").innerText =
        "Last updated: " + lastRecord.ts.toLocaleString();

      renderLatest(lastRecord);
      renderTrends(labels, airFix, humFix, watFix, n, p, k);
    });
}

function renderLatest(r) {
  const ctx = document.getElementById("latestChart");
  if (latestChart) latestChart.destroy();
  latestChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Air Temp","Humidity","Water Temp","N","P","K","tN","tP","tK"],
      datasets: [{ data: [r.airTemp,r.humidity,r.waterTemp,r.n,r.p,r.k,r.tN,r.tP,r.tK] }]
    }
  });
}

function renderTrends(lbl, air, hum, wat, n, p, k) {

  if (airTempChart) airTempChart.destroy();
  airTempChart = new Chart(document.getElementById("airTempChart").getContext("2d"), {
    type:"line",
    data:{ labels:lbl, datasets:[{label:"Air Temp (°C)",data:air, borderColor:"blue", fill:false}]}
  });

  if (humidityChart) humidityChart.destroy();
  humidityChart = new Chart(document.getElementById("humidityChart").getContext("2d"), {
    type:"line",
    data:{ labels:lbl, datasets:[{label:"Humidity (%)",data:hum, borderColor:"green", fill:false}]}
  });

  if (waterTempChart) waterTempChart.destroy();
  waterTempChart = new Chart(document.getElementById("waterTempChart").getContext("2d"), {
    type:"line",
    data:{ labels:lbl, datasets:[{label:"Water Temp (°C)",data:wat, borderColor:"darkcyan", fill:false}]}
  });

  if (npkChart) npkChart.destroy();
  npkChart = new Chart(document.getElementById("npkChart").getContext("2d"), {
    type:"line",
    data:{ labels:lbl, datasets:[
      {label:"N",data:n,borderColor:"red",fill:false},
      {label:"P",data:p,borderColor:"orange",fill:false},
      {label:"K",data:k,borderColor:"purple",fill:false}
    ]}
  });

}

// Load and refresh
loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
