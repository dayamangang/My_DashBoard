<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT-based Aquaponic Dashboard</title>

<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #eaf4ff; }
  h1 { text-align: center; color: #0047b3; margin-bottom: 5px; font-size: 30px; font-weight: bold; }
  h2 { text-align: center; color: #003d99; font-size: 20px; margin-bottom: 10px; }
  .updated-time { text-align: center; font-size: 12px; color: #555; margin-bottom: 5px; }
  .credit { text-align: center; font-size: 12px; color: #444; margin-bottom: 20px; }

  .chart-container {
    width: 95%;
    max-width: 1000px;
    margin: 0 auto 30px auto;
    background: white;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.12);
  }
  canvas {
    width: 100% !important;
    height: 360px !important;
  }

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>IoT-based Aquaponic Dashboard</h1>
<div class="updated-time" id="updatedTime">Loading latest readings...</div>
<p class="credit"><strong>Developed by Dr. Huidrom Dayananda Singh</strong></p>

<div class="chart-container">
  <h2>Latest Value (All Parameters)</h2>
  <canvas id="latestChart"></canvas>
</div>

<div class="chart-container">
  <h2>Air Temperature Trend (Last 12 Hours)</h2>
  <canvas id="airTempChart"></canvas>
</div>

<div class="chart-container">
  <h2>Air Humidity Trend (Last 12 Hours)</h2>
  <canvas id="humidityChart"></canvas>
</div>

<div class="chart-container">
  <h2>Water Temperature Trend (Last 12 Hours)</h2>
  <canvas id="waterTempChart"></canvas>
</div>

<div class="chart-container">
  <h2>NPK Trend (Last 12 Hours)</h2>
  <canvas id="npkChart"></canvas>
</div>

<script>
// Google Sheet setup
const sheetID = "1xfkdl2oWvB-HSpLBRwjj31YBCb-YDTUhjTJhVnW2o_g"; 
const sheetName = "Sheet1";
const apiURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

// Chart instances
let latestChart, airTempChart, humidityChart, waterTempChart, npkChart;

// Fix zeros only for charts (Option C)
function fixZerosForCharts(arr) {
  const newArr = [...arr];
  for (let i = 0; i < newArr.length; i++) {
    if (newArr[i] === 0 || isNaN(newArr[i])) {
      let prev = null, next = null;

      for (let p = i - 1; p >= 0; p--) {
        if (newArr[p] !== 0 && !isNaN(newArr[p])) { prev = newArr[p]; break; }
      }
      for (let n = i + 1; n < newArr.length; n++) {
        if (newArr[n] !== 0 && !isNaN(newArr[n])) { next = newArr[n]; break; }
      }

      if (prev !== null && next !== null) newArr[i] = (prev + next) / 2; 
      else if (prev !== null) newArr[i] = prev;
      else if (next !== null) newArr[i] = next;
    }
  }
  return newArr;
}

function parseDateTime(d, t) {
  const dn = d.match(/\d+/g); if (!dn) return null;
  const date = new Date(+dn[0], +dn[1], +dn[2]);

  const tn = t?.match(/\d+/g);
  if (tn) date.setHours(+tn[3], +tn[4], +tn[5]);
  
  return date;
}

function loadData() {
  fetch(apiURL)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      const rows = json.table.rows;

      const now = new Date();
      const cutoff = new Date(now.getTime() - 12 * 60 * 60 * 1000);

      let lastRecord = null;
      const labels=[], airT=[], hum=[], wT=[], N=[], P=[], K=[];

      rows.forEach(row => {
        const c = row.c;
        const ts = parseDateTime(c[0]?.v, c[1]?.v);
        if (!ts) return;

        lastRecord = {
          ts,
          airTemp: +c[2]?.v,
          humidity: +c[3]?.v,
          waterTemp: +c[4]?.v,
          n: +c[5]?.v, p: +c[6]?.v, k: +c[7]?.v,
          tN: +c[8]?.v, tP: +c[9]?.v, tK: +c[10]?.v
        };

        if (ts >= cutoff) {
          labels.push(ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
          airT.push(lastRecord.airTemp);
          hum.push(lastRecord.humidity);
          wT.push(lastRecord.waterTemp);
          N.push(lastRecord.n); P.push(lastRecord.p); K.push(lastRecord.k);
        }
      });

      if (!lastRecord) return;

      document.getElementById("updatedTime").innerText =
        "Last updated: " + lastRecord.ts.toLocaleString();

      renderLatest(lastRecord);
      renderTrends(labels,
        fixZerosForCharts(airT),
        fixZerosForCharts(hum),
        fixZerosForCharts(wT),
        fixZerosForCharts(N),
        fixZerosForCharts(P),
        fixZerosForCharts(K));
    });
}

function renderLatest(r) {
  const ctx = document.getElementById("latestChart");
  if (latestChart) latestChart.destroy();

  latestChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Air Temp","Humidity","Water Temp","N","P","K","tN","tP","tK"],
      datasets: [{
        label: "Latest Reading",
        data: [r.airTemp,r.humidity,r.waterTemp,r.n,r.p,r.k,r.tN,r.tP,r.tK]
      }]
    },
    options: { responsive:true }
  });
}

function renderTrends(lbl, air, humi, wat, n, p, k) {
  function makeChart(id, label, data, fill=false) {
    const c = document.getElementById(id);
    if (window[id]) window[id].destroy();
    window[id] = new Chart(c, {
      type: "line",
      data: { labels: lbl, datasets: [{ label, data, fill }] },
      options: { responsive:true }
    });
  }
  makeChart("airTempChart","°C",air);
  makeChart("humidityChart","%",humi);
  makeChart("waterTempChart","°C",wat);
  new Chart(document.getElementById("npkChart"),{
    type:"line",
    data:{
      labels:lbl,
      datasets:[
        {label:"N",data:n,fill:false},
        {label:"P",data:p,fill:false},
        {label:"K",data:k,fill:false}
      ]
    },
    options:{responsive:true}
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
